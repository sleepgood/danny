import React, { useState, useEffect } from 'react';
import { LineChart, Line, XAxis, YAxis, Tooltip, ResponsiveContainer } from 'recharts';

const BitcoinHeadChart = () => {
  const [data, setData] = useState([]);
  const [latestPrice, setLatestPrice] = useState(0);
  const [priceRange, setPriceRange] = useState({ min: 0, max: 0 });

  // Fetch historical data first
  useEffect(() => {
    const fetchHistorical = async () => {
      try {
        const response = await fetch(
          'https://min-api.cryptocompare.com/data/v2/histominute?fsym=BTC&tsym=USD&limit=60'
        );
        const result = await response.json();
        if (result.Data?.Data) {
          const historicalData = result.Data.Data.map(point => ({
            time: new Date(point.time * 1000).toLocaleTimeString(),
            price: point.close
          }));
          
          // Calculate price range with 2% padding
          const prices = historicalData.map(d => d.price);
          const min = Math.min(...prices);
          const max = Math.max(...prices);
          const padding = (max - min) * 0.02;
          setPriceRange({
            min: Math.floor(min - padding),
            max: Math.ceil(max + padding)
          });
          
          setData(historicalData);
          setLatestPrice(historicalData[historicalData.length - 1].price);
        }
      } catch (error) {
        console.error('Error fetching historical data:', error);
      }
    };
    fetchHistorical();
  }, []);

  // Fetch new price updates
  useEffect(() => {
    const fetchLatestPrice = async () => {
      try {
        const response = await fetch(
          'https://min-api.cryptocompare.com/data/price?fsym=BTC&tsym=USD'
        );
        const result = await response.json();
        if (result.USD) {
          const newPrice = result.USD;
          const newDataPoint = {
            time: new Date().toLocaleTimeString(),
            price: newPrice
          };
          
          // Update price range if needed
          if (newPrice > priceRange.max || newPrice < priceRange.min) {
            const padding = (priceRange.max - priceRange.min) * 0.02;
            setPriceRange({
              min: Math.floor(Math.min(priceRange.min, newPrice) - padding),
              max: Math.ceil(Math.max(priceRange.max, newPrice) + padding)
            });
          }
          
          setLatestPrice(newPrice);
          setData(prevData => [...prevData.slice(-59), newDataPoint]);
        }
      } catch (error) {
        console.error('Error fetching latest price:', error);
      }
    };

    const interval = setInterval(fetchLatestPrice, 10000); // Update every 10 seconds
    return () => clearInterval(interval);
  }, [priceRange]);

  return (
    <div className="w-full h-screen bg-gray-900 flex flex-col items-center justify-center p-4">
      <div className="text-white text-2xl mb-4">
        Bitcoin Price: ${latestPrice.toLocaleString(undefined, { maximumFractionDigits: 2 })}
      </div>
      <div className="relative w-full h-[600px]">
        <img 
          src="images/IMG_3457.png" 
          alt="Floating head" 
          className="absolute z-10 w-16 h-16 rounded-full shadow-lg"
          style={{
            top: `${100 - ((latestPrice - priceRange.min) / (priceRange.max - priceRange.min) * 100)}%`,
            left: `calc(100% - 32px)`,
            transition: 'all 0.5s ease-out',
            transform: 'translateY(-50%)'
          }}
        />
        <ResponsiveContainer width="100%" height="100%">
          <LineChart data={data}>
            <XAxis 
              dataKey="time" 
              stroke="#fff"
              tick={{ fill: '#fff', fontSize: 12 }}
              interval="preserveStartEnd"
            />
            <YAxis 
              domain={[priceRange.min, priceRange.max]}
              stroke="#fff"
              tick={{ fill: '#fff', fontSize: 12 }}
              tickCount={8}
              tickFormatter={value => value.toLocaleString(undefined, { maximumFractionDigits: 0 })}
            />
            <Tooltip 
              contentStyle={{ 
                background: '#1a1a2e', 
                border: '1px solid #fff',
                borderRadius: '8px'
              }}
              labelStyle={{ color: '#fff' }}
              formatter={value => ['$' + value.toLocaleString(), 'Price']}
            />
            <Line 
              type="monotone" 
              dataKey="price" 
              stroke="#00ff00" 
              strokeWidth={2}
              dot={false}
              isAnimationActive={false}
            />
          </LineChart>
        </ResponsiveContainer>
      </div>
    </div>
  );
};

export default BitcoinHeadChart;